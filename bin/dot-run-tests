#! /usr/bin/env zsh

dot-run-tests() {
    local out=0
    local test_file test_name

    local test_dir="${DOTFILES}/${1}/tests"

    for test_file in "${test_dir}"/**/*.test.zsh(.N); do
        local test_name="${test_file:t:r:r}"
        print-header blue --icon ðŸ§ª "Running: $test_name"
        local exit_code=0
        zsh "$test_file" || exit_code=$?

        if (( exit_code )); then
            print-header -e "Failed: ${test_name}"
            (( out += $exit_code ))
        else
            print-header green "Success: ${test_name}"
        fi
    done

    if (( out )); then
        print-header -e "$out tests failed."
    else
        print-header green "All Tests Passed!"
    fi

    if [[ -d "${test_dir}/failed-results/" ]]; then
        if [ -z "$(ls -A "${test_dir}/failed-results/")" ]; then
            rmdir "${test_dir}/failed-results/"
        fi
    fi

    return $out
}

(
    cd "${DOTFILES}"

    local sub_dirs=("bin" "bin-func")

    local sub_dir
    for sub_dir in "${sub_dirs[@]}"; do
        if [[ ! -d "${DOTFILES}/${sub_dir}/tests" ]]; then
            print-header -w "Test directory "${DOTFILES}/${sub_dir}/tests" does not exist."
            continue
        fi

        dot-run-tests "$sub_dir" "$@"
    done
)
